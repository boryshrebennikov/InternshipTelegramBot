[
    {
        "id": "dbbd86af.74c0d8",
        "type": "tab",
        "label": "Base Flow",
        "disabled": false,
        "info": ""
    },
    {
        "id": "96f6108e.64a37",
        "type": "tab",
        "label": "Start command",
        "disabled": false,
        "info": ""
    },
    {
        "id": "4c6874fb.68b9dc",
        "type": "tab",
        "label": "Editing username",
        "disabled": false,
        "info": ""
    },
    {
        "id": "3b5b98a.1c38768",
        "type": "tab",
        "label": "Editing location",
        "disabled": false,
        "info": ""
    },
    {
        "id": "68a30d94.469f94",
        "type": "tab",
        "label": "Editing occupation",
        "disabled": false,
        "info": ""
    },
    {
        "id": "276bc02d.e347",
        "type": "tab",
        "label": "Info Flow",
        "disabled": false,
        "info": ""
    },
    {
        "id": "cbf72f33.63dd6",
        "type": "tab",
        "label": "Chatting",
        "disabled": false,
        "info": ""
    },
    {
        "id": "411ddac8.164cb4",
        "type": "subflow",
        "name": "Send message to the chat",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 140,
                "y": 80,
                "wires": [
                    {
                        "id": "bd92a1fe.c5f6f"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 720,
                "y": 80,
                "wires": [
                    {
                        "id": "b8d99eac.ee468",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "color": "#DDAA99"
    },
    {
        "id": "4001764a.8341f8",
        "type": "subflow",
        "name": "Remove inline keyboard",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 160,
                "y": 80,
                "wires": [
                    {
                        "id": "a46d83e7.59837"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 1980,
                "y": 80,
                "wires": [
                    {
                        "id": "cfe21d91.ca59b",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "color": "#DDAA99"
    },
    {
        "id": "529c4263.aeab0c",
        "type": "MySQLdatabase",
        "name": "",
        "host": "localhost",
        "port": "3306",
        "db": "internship_telegram_bot",
        "tz": "",
        "charset": "UTF8"
    },
    {
        "id": "b513f9.a96b5c08",
        "type": "dialogflowv2-token",
        "name": "Questions"
    },
    {
        "id": "95f1f9c.778f308",
        "type": "dialogflowv2-token",
        "name": "dialogflow_node_red"
    },
    {
        "id": "b1d13c89.82a1",
        "type": "http in",
        "z": "dbbd86af.74c0d8",
        "name": "",
        "url": "/bot",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 180,
        "y": 780,
        "wires": [
            [
                "8b708744.7cb6f8",
                "98632046.faae7",
                "ac7f1cdc.11adc"
            ]
        ]
    },
    {
        "id": "8b708744.7cb6f8",
        "type": "debug",
        "z": "dbbd86af.74c0d8",
        "name": "Incoming data",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 560,
        "y": 860,
        "wires": []
    },
    {
        "id": "98632046.faae7",
        "type": "http response",
        "z": "dbbd86af.74c0d8",
        "name": "",
        "statusCode": "200",
        "headers": {},
        "x": 540,
        "y": 920,
        "wires": []
    },
    {
        "id": "ac7f1cdc.11adc",
        "type": "function",
        "z": "dbbd86af.74c0d8",
        "name": "Formatting data",
        "func": "if (msg.payload.message) {\n    msg.message = msg.payload.message.text;\n    \n    msg.chat_id = msg.payload.message.from.id\n    \n    return [null, msg]; \n} else if (msg.payload.callback_query) {\n    msg.message = msg.payload.callback_query.data;\n    \n    msg.chat_id = msg.payload.callback_query.from.id\n}\n\nif (msg.message.startsWith(\"^\")) {\n    msg.payload.message = msg.payload.callback_query.message;\n    \n    delete msg.payload.callback_query;\n    \n    return [null, msg];\n} else {\n    return [msg, null];\n}\n\n",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 540,
        "y": 780,
        "wires": [
            [
                "9cad4d0b.fc7ed"
            ],
            [
                "cc8aeb38.8caae8"
            ]
        ]
    },
    {
        "id": "769f8e60.75d1d",
        "type": "http in",
        "z": "dbbd86af.74c0d8",
        "name": "",
        "url": "/callback_query",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 140,
        "y": 840,
        "wires": [
            [
                "8b708744.7cb6f8",
                "98632046.faae7",
                "ac7f1cdc.11adc"
            ]
        ]
    },
    {
        "id": "9cad4d0b.fc7ed",
        "type": "switch",
        "z": "dbbd86af.74c0d8",
        "name": "Callback_Query_Intents",
        "property": "message",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "setCurrentName",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "setName",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "setCity",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "setOccupationAsAnApplicant",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "setOccupationAsOneOfTheParents",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "setOccupationAsATeacher",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "setOccupationAsAStudent",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "setOccupationAsOther",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "mainMenu",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "theMostPopularQuestions",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "aboutISMDepartment",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "aboutNULP",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "usingBot",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 13,
        "x": 910,
        "y": 540,
        "wires": [
            [
                "9dae952d.b2be48"
            ],
            [
                "bc2b504d.e7b25"
            ],
            [
                "67e90bd9.a1e8c4"
            ],
            [
                "2b168ecb.915b02"
            ],
            [
                "84969f23.caa1"
            ],
            [
                "b50620a8.7515"
            ],
            [
                "1356b19c.1cb64e"
            ],
            [
                "ce92fb67.2ac148"
            ],
            [
                "1771062a.6b9e4a"
            ],
            [
                "fd346d51.349be"
            ],
            [
                "1c95075d.3fbc99"
            ],
            [
                "1c95075d.3fbc99"
            ],
            [
                "1c95075d.3fbc99"
            ]
        ]
    },
    {
        "id": "2cfd1290.cbdfde",
        "type": "link out",
        "z": "dbbd86af.74c0d8",
        "name": "/start",
        "links": [
            "20e0ef34.86f5",
            "bb24cad3.d57618"
        ],
        "x": 1395,
        "y": 1000,
        "wires": []
    },
    {
        "id": "96e4744d.d20358",
        "type": "link out",
        "z": "dbbd86af.74c0d8",
        "name": "Set username to default name",
        "links": [
            "49db1ec2.c7de4"
        ],
        "x": 1895,
        "y": 140,
        "wires": []
    },
    {
        "id": "b48e521d.7a459",
        "type": "link out",
        "z": "dbbd86af.74c0d8",
        "name": "Set username",
        "links": [
            "407592c4.adb5ec"
        ],
        "x": 1895,
        "y": 180,
        "wires": []
    },
    {
        "id": "51ec0c6.d7d05f4",
        "type": "link out",
        "z": "dbbd86af.74c0d8",
        "name": "Process message",
        "links": [
            "957981a1.8fdad",
            "62416c5b.bd8764",
            "5581481b.706b38"
        ],
        "x": 1395,
        "y": 1100,
        "wires": []
    },
    {
        "id": "fee03af4.838098",
        "type": "link out",
        "z": "dbbd86af.74c0d8",
        "name": "Print main menu",
        "links": [
            "f1be3b15.c41ab8"
        ],
        "x": 1895,
        "y": 600,
        "wires": []
    },
    {
        "id": "83a6c20c.1b51b",
        "type": "function",
        "z": "4c6874fb.68b9dc",
        "name": "Updating user name",
        "func": "//for the next question\nmsg.text = \"Зрозуміло. Де ви проживаєте?\";\n\nif(msg.payload.callback_query) {\n    msg.first_name = msg.payload.callback_query.message.chat.first_name ? msg.payload.callback_query.message.chat.first_name : '';\n    msg.last_name = msg.payload.callback_query.message.chat.last_name ? msg.payload.callback_query.message.chat.last_name : '';\n    \n    msg.topic = \"UPDATE Users SET username = '\" + msg.first_name + \" \" + msg.last_name + \"' WHERE user_telegram_id = \" + msg.chat_id + \";\";\n} else {\n    msg.first_name = msg.payload.message.chat.first_name ? msg.payload.message.chat.first_name : '';\n    msg.last_name = msg.payload.message.chat.last_name ? msg.payload.message.chat.last_name : '';\n    \n    msg.topic = \"UPDATE Users SET username = '\" + msg.first_name + \" \" + msg.last_name + \"' WHERE user_telegram_id = \" + msg.chat_id + \";\";\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 440,
        "y": 160,
        "wires": [
            [
                "573aa76b.c47f38"
            ]
        ]
    },
    {
        "id": "49db1ec2.c7de4",
        "type": "link in",
        "z": "4c6874fb.68b9dc",
        "name": "Set username to default name",
        "links": [
            "96e4744d.d20358"
        ],
        "x": 235,
        "y": 160,
        "wires": [
            [
                "83a6c20c.1b51b",
                "28cc6c0e.6a0174"
            ]
        ]
    },
    {
        "id": "573aa76b.c47f38",
        "type": "mysql",
        "z": "4c6874fb.68b9dc",
        "mydb": "529c4263.aeab0c",
        "name": "",
        "x": 730,
        "y": 160,
        "wires": [
            [
                "f553be12.15931",
                "4d10c364.bba70c"
            ]
        ]
    },
    {
        "id": "f553be12.15931",
        "type": "debug",
        "z": "4c6874fb.68b9dc",
        "name": "Setting username to default response from db",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1080,
        "y": 240,
        "wires": []
    },
    {
        "id": "28cc6c0e.6a0174",
        "type": "debug",
        "z": "4c6874fb.68b9dc",
        "name": "Setting username to default incoming data",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 450,
        "y": 240,
        "wires": []
    },
    {
        "id": "643d38df.03a4c8",
        "type": "function",
        "z": "4c6874fb.68b9dc",
        "name": "Setting up response",
        "func": "msg.payload = {\n    text: \"Вкажіть, будь ласка, своє ім'я👇\",\n    chat_id: msg.chat_id\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1820,
        "y": 160,
        "wires": [
            [
                "c538e448.9052c8"
            ]
        ]
    },
    {
        "id": "407592c4.adb5ec",
        "type": "link in",
        "z": "4c6874fb.68b9dc",
        "name": "Send request message to enter a new username",
        "links": [
            "b48e521d.7a459",
            "ba2be4d7.46a368"
        ],
        "x": 1605,
        "y": 160,
        "wires": [
            [
                "643d38df.03a4c8"
            ]
        ]
    },
    {
        "id": "4d10c364.bba70c",
        "type": "link out",
        "z": "4c6874fb.68b9dc",
        "name": "Move on to setting the location field",
        "links": [
            "b0af6159.780a4",
            "1835ced7.6011d1"
        ],
        "x": 935,
        "y": 160,
        "wires": []
    },
    {
        "id": "f1be3b15.c41ab8",
        "type": "link in",
        "z": "276bc02d.e347",
        "name": "Print main menu",
        "links": [
            "9d38cfeb.72544",
            "cfe6162e.b07178",
            "fee03af4.838098",
            "76361c43.ee74f4",
            "59d394d6.305dac"
        ],
        "x": 215,
        "y": 200,
        "wires": [
            [
                "1f8a7993.a04976"
            ]
        ]
    },
    {
        "id": "1f8a7993.a04976",
        "type": "function",
        "z": "276bc02d.e347",
        "name": "Setting up message with main menu",
        "func": "msg.payload = {\n    text: \"✅ Ви в головному меню. Виберіть необхідний пункт\",\n    reply_markup: {\n        inline_keyboard: [[\n            {\n                text: \"Найпопулярніші питання 🔥\",\n                callback_data: \"theMostPopularQuestions\"            \n            }], \n            [{\n                text: \"Про кафедру ICM 😎\",\n                callback_data: \"aboutISMDepartment\"            \n            },\n            {\n                text: \"Про НУЛП 🚀\",\n                callback_data: \"aboutNULP\"            \n            }],\n            [{\n                text: \"Як користуватися ботом 📁\",\n                callback_data: \"usingBot\"            \n            }]\n        ]\n    },\n    chat_id: msg.chat_id\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 470,
        "y": 200,
        "wires": [
            [
                "511ccf6f.c54f1"
            ]
        ]
    },
    {
        "id": "2b168ecb.915b02",
        "type": "link out",
        "z": "dbbd86af.74c0d8",
        "name": "Set occupation as an applicant",
        "links": [
            "3272d461.c8fe5c",
            "ed917a17.8e5078"
        ],
        "x": 1395,
        "y": 380,
        "wires": []
    },
    {
        "id": "84969f23.caa1",
        "type": "link out",
        "z": "dbbd86af.74c0d8",
        "name": "Set occupation as one of the parents",
        "links": [
            "84f1ccf3.e8c91",
            "4f5ec5f6.e9838c"
        ],
        "x": 1395,
        "y": 420,
        "wires": []
    },
    {
        "id": "b50620a8.7515",
        "type": "link out",
        "z": "dbbd86af.74c0d8",
        "name": "Set occupation as a teacher",
        "links": [
            "7ed591d4.8c433",
            "f2c3d2a0.25b49"
        ],
        "x": 1395,
        "y": 460,
        "wires": []
    },
    {
        "id": "1356b19c.1cb64e",
        "type": "link out",
        "z": "dbbd86af.74c0d8",
        "name": "Set occupation as a student",
        "links": [
            "6ef222d3.893f0c",
            "4ed757e7.456528"
        ],
        "x": 1395,
        "y": 500,
        "wires": []
    },
    {
        "id": "ce92fb67.2ac148",
        "type": "link out",
        "z": "dbbd86af.74c0d8",
        "name": "Set occupation as other",
        "links": [
            "bebaf9fd.57b3d8",
            "bcbdc401.9580e8"
        ],
        "x": 1395,
        "y": 540,
        "wires": []
    },
    {
        "id": "3e335eba.efe392",
        "type": "comment",
        "z": "dbbd86af.74c0d8",
        "name": "Set occupation",
        "info": "# Setting occupation",
        "x": 1460,
        "y": 340,
        "wires": []
    },
    {
        "id": "3671d50b.6c473a",
        "type": "comment",
        "z": "dbbd86af.74c0d8",
        "name": "Main menu",
        "info": "",
        "x": 1940,
        "y": 560,
        "wires": []
    },
    {
        "id": "d838b14c.4ad9b",
        "type": "comment",
        "z": "dbbd86af.74c0d8",
        "name": "Other messages",
        "info": "",
        "x": 1460,
        "y": 1060,
        "wires": []
    },
    {
        "id": "2debe527.475a1a",
        "type": "comment",
        "z": "dbbd86af.74c0d8",
        "name": "Edit name",
        "info": "",
        "x": 1940,
        "y": 100,
        "wires": []
    },
    {
        "id": "37feab15.469a44",
        "type": "comment",
        "z": "4c6874fb.68b9dc",
        "name": "Setting username to default name",
        "info": "",
        "x": 350,
        "y": 120,
        "wires": []
    },
    {
        "id": "56b28ca1.adcfe4",
        "type": "comment",
        "z": "4c6874fb.68b9dc",
        "name": "Request message to enter a new username",
        "info": "",
        "x": 1760,
        "y": 120,
        "wires": []
    },
    {
        "id": "eb6872ba.76213",
        "type": "comment",
        "z": "276bc02d.e347",
        "name": "Message with main menu",
        "info": "",
        "x": 310,
        "y": 160,
        "wires": []
    },
    {
        "id": "29b87cf7.8de694",
        "type": "debug",
        "z": "4c6874fb.68b9dc",
        "name": "Setting username field to 'editing' response from db",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 3170,
        "y": 220,
        "wires": []
    },
    {
        "id": "66c7218a.a9dc1",
        "type": "mysql",
        "z": "4c6874fb.68b9dc",
        "mydb": "529c4263.aeab0c",
        "name": "",
        "x": 2820,
        "y": 160,
        "wires": [
            [
                "29b87cf7.8de694"
            ]
        ]
    },
    {
        "id": "32bc9488.39455c",
        "type": "function",
        "z": "4c6874fb.68b9dc",
        "name": "Changing username field",
        "func": "msg.topic = \"UPDATE Users SET username = '/editingField3252346' WHERE user_telegram_id = \" + msg.chat_id + \";\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2480,
        "y": 160,
        "wires": [
            [
                "66c7218a.a9dc1"
            ]
        ]
    },
    {
        "id": "67e90bd9.a1e8c4",
        "type": "link out",
        "z": "dbbd86af.74c0d8",
        "name": "Set city",
        "links": [
            "b0af6159.780a4",
            "1835ced7.6011d1"
        ],
        "x": 1395,
        "y": 280,
        "wires": []
    },
    {
        "id": "15de1cc3.526003",
        "type": "comment",
        "z": "dbbd86af.74c0d8",
        "name": "Set the city field",
        "info": "",
        "x": 1460,
        "y": 240,
        "wires": []
    },
    {
        "id": "fdda8f0f.cc87c",
        "type": "comment",
        "z": "dbbd86af.74c0d8",
        "name": "Start",
        "info": "",
        "x": 1430,
        "y": 960,
        "wires": []
    },
    {
        "id": "cc8aeb38.8caae8",
        "type": "switch",
        "z": "dbbd86af.74c0d8",
        "name": "Start or message",
        "property": "message",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "/start",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "message",
                "vt": "msg"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 910,
        "y": 1040,
        "wires": [
            [
                "2cfd1290.cbdfde"
            ],
            [
                "51ec0c6.d7d05f4"
            ]
        ]
    },
    {
        "id": "e62923c4.ab898",
        "type": "link in",
        "z": "276bc02d.e347",
        "name": "Send the most popular questions",
        "links": [
            "19842b4d.d40f45"
        ],
        "x": 215,
        "y": 440,
        "wires": [
            [
                "ed557bc6.5bffa8"
            ]
        ]
    },
    {
        "id": "fd706c59.243ee",
        "type": "function",
        "z": "276bc02d.e347",
        "name": "Setting up message with the most popular questions",
        "func": "var messageText = \"\";\nmsg.payload.forEach((item, i, v) => {\n    messageText += (i + 1) + \". \" + item.question + \"\\n\\nВідповідь:\\n\" + item.answer + \"\\n\\n\";\n});\n\nmsg.payload = {\n    text: messageText,\n    chat_id: msg.chat_id,\n    reply_markup: {\n        inline_keyboard: [[\n            {\n                text: \"Головне меню\",\n                callback_data: \"mainMenu\"\n            }]\n        ]\n    },\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1240,
        "y": 440,
        "wires": [
            [
                "774ff602.a99368"
            ]
        ]
    },
    {
        "id": "758ec55e.3e202c",
        "type": "comment",
        "z": "276bc02d.e347",
        "name": "Message with the most popular questions",
        "info": "",
        "x": 360,
        "y": 400,
        "wires": []
    },
    {
        "id": "19842b4d.d40f45",
        "type": "link out",
        "z": "dbbd86af.74c0d8",
        "name": "Send the most popular questions",
        "links": [
            "e62923c4.ab898"
        ],
        "x": 1895,
        "y": 700,
        "wires": []
    },
    {
        "id": "1b324f6e.df2211",
        "type": "comment",
        "z": "dbbd86af.74c0d8",
        "name": "Send the most popular questions",
        "info": "",
        "x": 2010,
        "y": 660,
        "wires": []
    },
    {
        "id": "feec21d1.19a71",
        "type": "link out",
        "z": "dbbd86af.74c0d8",
        "name": "Send message about ISM department",
        "links": [
            "b25d1f4e.85ebd"
        ],
        "x": 1895,
        "y": 800,
        "wires": []
    },
    {
        "id": "b25d1f4e.85ebd",
        "type": "link in",
        "z": "276bc02d.e347",
        "name": "Send message info",
        "links": [
            "feec21d1.19a71"
        ],
        "x": 215,
        "y": 660,
        "wires": [
            [
                "1776db31.ba8455"
            ]
        ]
    },
    {
        "id": "1efe9538.956a1b",
        "type": "function",
        "z": "276bc02d.e347",
        "name": "Setting up message info",
        "func": "msg.payload = {\n    text: msg.payload[0].content,\n    chat_id: msg.chat_id,\n    reply_markup: {\n        inline_keyboard: [[\n            {\n                text: \"Головне меню\",\n                callback_data: \"mainMenu\"\n            }]\n        ]\n    },\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1050,
        "y": 660,
        "wires": [
            [
                "12dbdc86.9c06e3"
            ]
        ]
    },
    {
        "id": "5b85328f.b7748c",
        "type": "comment",
        "z": "276bc02d.e347",
        "name": "Message Info",
        "info": "",
        "x": 270,
        "y": 620,
        "wires": []
    },
    {
        "id": "9715f6c0.534af8",
        "type": "comment",
        "z": "dbbd86af.74c0d8",
        "name": "Send messages about ISM department, NULP, how to use the bot ",
        "info": "",
        "x": 2110,
        "y": 760,
        "wires": []
    },
    {
        "id": "1776db31.ba8455",
        "type": "function",
        "z": "276bc02d.e347",
        "name": "Getting info from InfoPages",
        "func": "msg.topic = \"SELECT content FROM InfoPages WHERE title = '\" + msg.payload.callback_query.data + \"';\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 440,
        "y": 660,
        "wires": [
            [
                "6d12fdae.161534"
            ]
        ]
    },
    {
        "id": "6d12fdae.161534",
        "type": "mysql",
        "z": "276bc02d.e347",
        "mydb": "529c4263.aeab0c",
        "name": "",
        "x": 730,
        "y": 660,
        "wires": [
            [
                "1efe9538.956a1b",
                "edb7746b.1cfc58"
            ]
        ]
    },
    {
        "id": "981f1664.6f90e8",
        "type": "comment",
        "z": "4c6874fb.68b9dc",
        "name": "Move on to setting the location field",
        "info": "",
        "x": 1060,
        "y": 120,
        "wires": []
    },
    {
        "id": "9dae952d.b2be48",
        "type": "change",
        "z": "dbbd86af.74c0d8",
        "name": "Saving message_id",
        "rules": [
            {
                "t": "set",
                "p": "message_id",
                "pt": "msg",
                "to": "payload.callback_query.message.message_id",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1470,
        "y": 140,
        "wires": [
            [
                "b7e1f0b9.548a"
            ]
        ]
    },
    {
        "id": "cab5fa05.8972f8",
        "type": "function",
        "z": "96f6108e.64a37",
        "name": "Setting up response to '/start' (Greeting part)",
        "func": "msg.payload = {\n    text: \"Привіт! Я бот кафедри ІСМ.👨‍💻З радістю допоможу знайти відповідь на всі ваші питання\",\n    chat_id: msg.chat_id\n}\n\nmsg.text = \"Давайте знайомитись ближче. Чи можу я до вас звертатися \" + msg.first_name + \" \" + msg.last_name + \"?\"\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1590,
        "y": 160,
        "wires": [
            [
                "c965d10e.f8642"
            ]
        ]
    },
    {
        "id": "20d295e5.2aa6ca",
        "type": "function",
        "z": "96f6108e.64a37",
        "name": "Setting up response to '/start' (Appeling part)",
        "func": "msg.payload = {\n    text: msg.text,\n    reply_markup: {\n        inline_keyboard: [[\n            {\n                text: \"Так, звісно\",\n                callback_data: \"setCurrentName\"\n            }, \n            {\n                text: \"Я хочу змінити\",\n                callback_data: \"setName\"\n            }]\n        ]\n    },\n    chat_id: msg.chat_id,\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 3650,
        "y": 160,
        "wires": [
            [
                "cece57bc.ae7278"
            ]
        ]
    },
    {
        "id": "e897d605.f901d8",
        "type": "mysql",
        "z": "96f6108e.64a37",
        "mydb": "529c4263.aeab0c",
        "name": "",
        "x": 870,
        "y": 220,
        "wires": [
            [
                "41e89314.19813c",
                "776fd5bc.aa182c"
            ]
        ]
    },
    {
        "id": "41e89314.19813c",
        "type": "debug",
        "z": "96f6108e.64a37",
        "name": "Getting username field in 'start command flow' response from db",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1250,
        "y": 300,
        "wires": []
    },
    {
        "id": "776fd5bc.aa182c",
        "type": "function",
        "z": "96f6108e.64a37",
        "name": "Checking presence of user row",
        "func": "if (msg.payload.length) return [null, msg];\nelse return [msg, null];",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1170,
        "y": 220,
        "wires": [
            [
                "cab5fa05.8972f8"
            ],
            [
                "dfdde4d6.912358"
            ]
        ]
    },
    {
        "id": "af301238.403c5",
        "type": "function",
        "z": "96f6108e.64a37",
        "name": "Registering new user row in db",
        "func": "if (msg.register) {\n    msg.topic = \"INSERT INTO Users (user_telegram_id) VALUES (\" + msg.chat_id + \");\";\n\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2310,
        "y": 160,
        "wires": [
            [
                "c96c634c.1f6d8"
            ]
        ]
    },
    {
        "id": "c96c634c.1f6d8",
        "type": "mysql",
        "z": "96f6108e.64a37",
        "mydb": "529c4263.aeab0c",
        "name": "",
        "x": 2670,
        "y": 160,
        "wires": [
            [
                "cf2ccd6.502a93",
                "20d295e5.2aa6ca"
            ]
        ]
    },
    {
        "id": "cf2ccd6.502a93",
        "type": "debug",
        "z": "96f6108e.64a37",
        "name": "Registering new user response from db",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 3000,
        "y": 80,
        "wires": []
    },
    {
        "id": "de1e2237.23c0a",
        "type": "function",
        "z": "96f6108e.64a37",
        "name": "Getting user row",
        "func": "msg.register = true;\n\nmsg.first_name = msg.payload.message.chat.first_name ? msg.payload.message.chat.first_name : '';\nmsg.last_name = msg.payload.message.chat.last_name ? msg.payload.message.chat.last_name : '';\n\nmsg.message_id = msg.payload.message.message_id - 1;\n\nif (!msg.first_name && !msg.last_name) return [null, msg];\n\nmsg.topic = \"SELECT * FROM Users WHERE user_telegram_id = \" + msg.chat_id + \";\";\n\nreturn [msg, null];",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 460,
        "y": 340,
        "wires": [
            [
                "e897d605.f901d8"
            ],
            [
                "ba2be4d7.46a368"
            ]
        ]
    },
    {
        "id": "bb24cad3.d57618",
        "type": "link in",
        "z": "96f6108e.64a37",
        "name": "Start",
        "links": [
            "2cfd1290.cbdfde"
        ],
        "x": 235,
        "y": 340,
        "wires": [
            [
                "de1e2237.23c0a",
                "954a6c74.4f585"
            ]
        ]
    },
    {
        "id": "fc1f4d6.e69b0b",
        "type": "comment",
        "z": "96f6108e.64a37",
        "name": "Start",
        "info": "",
        "x": 270,
        "y": 300,
        "wires": []
    },
    {
        "id": "dfdde4d6.912358",
        "type": "function",
        "z": "96f6108e.64a37",
        "name": "Is registration completed",
        "func": "msg.register = false;\n\nif (!msg.payload[0].username || msg.payload[0].username == \"/editingField3252346\") {\n    //for the next question\n    msg.text = \"Чи можу я до вас звертатися \" + msg.first_name + \" \" + msg.last_name + \"?\";\n    \n    return [msg, null, null, null];\n} else if (!msg.payload[0].city || msg.payload[0].city == \"/editingField3252346\") {\n    //for the next question\n    msg.text = \"Де ви проживаєте?\";\n    \n    return [null, msg, null, null];\n} else if (!msg.payload[0].occupation) {\n    //for the next message\n    msg.text = \"Для кращого підбору FAQ 📊 виберіть свій вид зайнятості\";\n    \n    return [null, null, msg, null];\n}\n\nreturn [null, null, null, msg];",
        "outputs": 4,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2170,
        "y": 360,
        "wires": [
            [
                "9ac7a5f6.6b0578"
            ],
            [
                "d8112410.42a728"
            ],
            [
                "62f11abc.785b54"
            ],
            [
                "76361c43.ee74f4"
            ]
        ],
        "inputLabels": [
            "Checking whether the registration is completed"
        ],
        "outputLabels": [
            "Move on to setting the username field again",
            "Move on to setting the location field again",
            "Move on to setting the occupation field again",
            "Send main menu message"
        ]
    },
    {
        "id": "d8112410.42a728",
        "type": "link out",
        "z": "96f6108e.64a37",
        "name": "Move on to setting the location field again",
        "links": [
            "1835ced7.6011d1"
        ],
        "x": 2475,
        "y": 420,
        "wires": []
    },
    {
        "id": "4984be9d.47765",
        "type": "link out",
        "z": "96f6108e.64a37",
        "name": "Move on to setting the occupation field again",
        "links": [
            "62bdcfd6.d166e"
        ],
        "x": 2735,
        "y": 480,
        "wires": []
    },
    {
        "id": "ba2be4d7.46a368",
        "type": "link out",
        "z": "96f6108e.64a37",
        "name": "Set username",
        "links": [
            "407592c4.adb5ec"
        ],
        "x": 775,
        "y": 440,
        "wires": []
    },
    {
        "id": "76361c43.ee74f4",
        "type": "link out",
        "z": "96f6108e.64a37",
        "name": "Send main menu message",
        "links": [
            "f1be3b15.c41ab8"
        ],
        "x": 2475,
        "y": 580,
        "wires": []
    },
    {
        "id": "bd590ee2.cbc7b",
        "type": "comment",
        "z": "96f6108e.64a37",
        "name": "Send main menu message",
        "info": "",
        "x": 2570,
        "y": 540,
        "wires": []
    },
    {
        "id": "6ff45d49.c66084",
        "type": "link in",
        "z": "96f6108e.64a37",
        "name": "Is registration completed",
        "links": [
            "452a3d2.72b81c4"
        ],
        "x": 1755,
        "y": 460,
        "wires": [
            [
                "dfdde4d6.912358"
            ]
        ]
    },
    {
        "id": "1835ced7.6011d1",
        "type": "link in",
        "z": "3b5b98a.1c38768",
        "name": "Send message to set the location field",
        "links": [
            "4d10c364.bba70c",
            "67e90bd9.a1e8c4",
            "ce2794d2.a63448",
            "fc83002f.8146f",
            "6f605b10.5004f4",
            "d8112410.42a728",
            "bba92257.ecedb"
        ],
        "x": 175,
        "y": 140,
        "wires": [
            [
                "d2a126cb.79b0c8"
            ]
        ]
    },
    {
        "id": "d2a126cb.79b0c8",
        "type": "function",
        "z": "3b5b98a.1c38768",
        "name": "Setting up question for location",
        "func": "msg.payload = {\n    text: msg.text,    \n    chat_id: msg.chat_id\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 470,
        "y": 140,
        "wires": [
            [
                "bcaa2825.03ec98"
            ]
        ]
    },
    {
        "id": "f83bba65.663248",
        "type": "function",
        "z": "3b5b98a.1c38768",
        "name": "Changing city field",
        "func": "msg.topic = \"UPDATE Users SET city = '/editingField3252346' WHERE user_telegram_id = \" + msg.chat_id + \";\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1170,
        "y": 140,
        "wires": [
            [
                "35525640.5c6d6a"
            ]
        ]
    },
    {
        "id": "35525640.5c6d6a",
        "type": "mysql",
        "z": "3b5b98a.1c38768",
        "mydb": "529c4263.aeab0c",
        "name": "",
        "x": 1490,
        "y": 140,
        "wires": [
            [
                "c6df9017.a5565"
            ]
        ]
    },
    {
        "id": "c6df9017.a5565",
        "type": "debug",
        "z": "3b5b98a.1c38768",
        "name": "Changing city field to 'editing' response from db",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1820,
        "y": 220,
        "wires": []
    },
    {
        "id": "64fc7f2f.7e856",
        "type": "comment",
        "z": "3b5b98a.1c38768",
        "name": "Request message to enter a location",
        "info": "",
        "x": 300,
        "y": 100,
        "wires": []
    },
    {
        "id": "62bdcfd6.d166e",
        "type": "link in",
        "z": "68a30d94.469f94",
        "name": "Send message to set the occupation field",
        "links": [
            "8a07dd6e.fb122",
            "eb6c15f.d5924e8",
            "cbb721f9.d1df5",
            "99c3c041.c38d3",
            "4984be9d.47765",
            "76dc39c7.1f1908"
        ],
        "x": 95,
        "y": 300,
        "wires": [
            [
                "c54069b2.59d4f8"
            ]
        ]
    },
    {
        "id": "c54069b2.59d4f8",
        "type": "function",
        "z": "68a30d94.469f94",
        "name": "Setting up 'choose occupation' message",
        "func": "msg.payload = {\n    text: msg.text,\n    reply_markup: {\n        inline_keyboard: [[\n            {\n                text: \"Абітурієнт\",\n                callback_data: \"setOccupationAsAnApplicant\"            \n            }, \n            {\n                text: \"Один з батьків\",\n                callback_data: \"setOccupationAsOneOfTheParents\"            \n            }],\n            [{\n                text: \"Викладач\",\n                callback_data: \"setOccupationAsATeacher\"            \n            },\n            {\n                text: \"Студент\",\n                callback_data: \"setOccupationAsAStudent\"            \n            }],\n            [{\n                text: \"Інше\",\n                callback_data: \"setOccupationAsOther\"            \n            }]\n        ]\n    },\n    chat_id: msg.chat_id\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 360,
        "y": 300,
        "wires": [
            [
                "6a938578.b8740c"
            ]
        ]
    },
    {
        "id": "efb68a90.a747e8",
        "type": "function",
        "z": "68a30d94.469f94",
        "name": "Set occupation as an applicant",
        "func": "msg.topic = \"UPDATE Users SET occupation = 'Applicant' WHERE user_telegram_id = \" + msg.chat_id + \";\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1870,
        "y": 180,
        "wires": [
            [
                "b39d786c.8e4128"
            ]
        ]
    },
    {
        "id": "35734a3f.d60566",
        "type": "function",
        "z": "68a30d94.469f94",
        "name": "Set occupation as one of the parents",
        "func": "msg.topic = \"UPDATE Users SET occupation = 'One of the parents' WHERE user_telegram_id = \" + msg.chat_id + \";\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1890,
        "y": 240,
        "wires": [
            [
                "b39d786c.8e4128"
            ]
        ]
    },
    {
        "id": "28c9f7e4.efea48",
        "type": "function",
        "z": "68a30d94.469f94",
        "name": "Set occupation as a teacher",
        "func": "msg.topic = \"UPDATE Users SET occupation = 'Teacher' WHERE user_telegram_id = \" + msg.chat_id + \";\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1860,
        "y": 300,
        "wires": [
            [
                "b39d786c.8e4128"
            ]
        ]
    },
    {
        "id": "564c6898.976ac8",
        "type": "function",
        "z": "68a30d94.469f94",
        "name": "Set occupation as a student",
        "func": "msg.topic = \"UPDATE Users SET occupation = 'Student' WHERE user_telegram_id = \" + msg.chat_id + \";\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1860,
        "y": 360,
        "wires": [
            [
                "b39d786c.8e4128"
            ]
        ]
    },
    {
        "id": "acac65a4.a6de98",
        "type": "function",
        "z": "68a30d94.469f94",
        "name": "Set occupation as other",
        "func": "msg.topic = \"UPDATE Users SET occupation = 'Other' WHERE user_telegram_id = \" + msg.chat_id + \";\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1850,
        "y": 420,
        "wires": [
            [
                "b39d786c.8e4128"
            ]
        ]
    },
    {
        "id": "bfff6d3f.b5c17",
        "type": "debug",
        "z": "68a30d94.469f94",
        "name": "Editing occupation field response from db",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 3160,
        "y": 360,
        "wires": []
    },
    {
        "id": "59d394d6.305dac",
        "type": "link out",
        "z": "68a30d94.469f94",
        "name": "Move on to printing main menu",
        "links": [
            "f1be3b15.c41ab8"
        ],
        "x": 3095,
        "y": 280,
        "wires": []
    },
    {
        "id": "ed917a17.8e5078",
        "type": "link in",
        "z": "68a30d94.469f94",
        "name": "Set occupation as an applicant",
        "links": [
            "2b168ecb.915b02"
        ],
        "x": 1415,
        "y": 180,
        "wires": [
            [
                "efb68a90.a747e8"
            ]
        ]
    },
    {
        "id": "4f5ec5f6.e9838c",
        "type": "link in",
        "z": "68a30d94.469f94",
        "name": "Set occupation as one of the parents",
        "links": [
            "84969f23.caa1"
        ],
        "x": 1415,
        "y": 240,
        "wires": [
            [
                "35734a3f.d60566"
            ]
        ]
    },
    {
        "id": "f2c3d2a0.25b49",
        "type": "link in",
        "z": "68a30d94.469f94",
        "name": "Set occupation as a teacher",
        "links": [
            "b50620a8.7515"
        ],
        "x": 1415,
        "y": 300,
        "wires": [
            [
                "28c9f7e4.efea48"
            ]
        ]
    },
    {
        "id": "4ed757e7.456528",
        "type": "link in",
        "z": "68a30d94.469f94",
        "name": "Set occupation as a student",
        "links": [
            "1356b19c.1cb64e"
        ],
        "x": 1415,
        "y": 360,
        "wires": [
            [
                "564c6898.976ac8"
            ]
        ]
    },
    {
        "id": "bcbdc401.9580e8",
        "type": "link in",
        "z": "68a30d94.469f94",
        "name": "Set occupation as other",
        "links": [
            "ce92fb67.2ac148"
        ],
        "x": 1415,
        "y": 420,
        "wires": [
            [
                "acac65a4.a6de98"
            ]
        ]
    },
    {
        "id": "f1632c06.222ac",
        "type": "comment",
        "z": "68a30d94.469f94",
        "name": "Setting occupation",
        "info": "",
        "x": 1490,
        "y": 140,
        "wires": []
    },
    {
        "id": "ba8647ee.f68c28",
        "type": "comment",
        "z": "68a30d94.469f94",
        "name": "Request message to choose an occupation",
        "info": "",
        "x": 240,
        "y": 260,
        "wires": []
    },
    {
        "id": "ea5c7390.3d1a9",
        "type": "comment",
        "z": "68a30d94.469f94",
        "name": "Move on to printing main menu",
        "info": "",
        "x": 3210,
        "y": 240,
        "wires": []
    },
    {
        "id": "65f1945a.2f170c",
        "type": "function",
        "z": "cbf72f33.63dd6",
        "name": "Getting username and city fields",
        "func": "if (msg.message != \"/start\") {\n    msg.first_name = msg.payload.message.chat.first_name ? msg.payload.message.chat.first_name : '';\n    msg.last_name = msg.payload.message.chat.last_name ? msg.payload.message.chat.last_name : '';\n    msg.message_id = msg.payload.message.message_id;\n    \n    msg.topic = \"SELECT username, city, occupation FROM Users WHERE user_telegram_id = '\" + msg.chat_id + \"';\";\n\n    return msg;\n}\n\n\nreturn null;\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 350,
        "y": 600,
        "wires": [
            [
                "99e2c09e.30ba3"
            ]
        ]
    },
    {
        "id": "99e2c09e.30ba3",
        "type": "mysql",
        "z": "cbf72f33.63dd6",
        "mydb": "529c4263.aeab0c",
        "name": "",
        "x": 670,
        "y": 600,
        "wires": [
            [
                "e0bc4239.7e156",
                "feea9eea.8f9fd"
            ]
        ]
    },
    {
        "id": "e0bc4239.7e156",
        "type": "function",
        "z": "cbf72f33.63dd6",
        "name": "Editing username or city or move on to processing message",
        "func": "function setErrorMessage(text) {\n    if (msg.message == \"/editingField3252346\") {\n        msg.payload = {\n            text: text,\n            chat_id: msg.chat_id\n        }\n        \n        return false;\n    }\n    \n    return true;\n}\n\nfunction isTooLongAnswer(text) {\n    if (msg.message.length > 120) {\n        msg.payload = {\n            text: text,\n            chat_id: msg.chat_id\n        }\n        \n        return true;\n    }\n    \n    return false;\n}\n\nif (msg.payload[0]) {\n    if (msg.payload[0].occupation) {\n        //sending saved contexts\n        msg.queryParams = {\n            contexts: global.get(msg.chat_id.toString())\n        };\n        \n        //slice if it is answer to dialogflow question\n        if (msg.message.startsWith(\"^\")) {\n            msg.payload = msg.message.slice(1);\n        } else {\n            msg.payload = msg.message;\n        }\n        \n        return [null, null, null, msg, null];\n    }\n    if (msg.payload[0].username && msg.payload[0].username == \"/editingField3252346\" && setErrorMessage(\"Вкажіть, будь ласка, коректне ім'я\")) {\n        if (isTooLongAnswer(\"Ви ввели задуже довге ім'я\")) return [null, null, msg, null, null];\n        \n        msg.topic = \"UPDATE Users SET username = '\" + msg.message + \"' WHERE user_telegram_id = \" + msg.chat_id + \";\";\n        //for the next question\n        msg.text = \"Зрозуміло. Де ви проживаєте?\";\n        \n        return [msg, null, null, null, null];\n    } else if (msg.payload[0].city && msg.payload[0].city == \"/editingField3252346\" && setErrorMessage(\"Вкажіть, будь ласка, коректне місто\")) {\n        if (isTooLongAnswer(\"Ви ввели задуже довгу відповідь\")) return [null, null, msg, null, null];\n        \n        msg.topic = \"UPDATE Users SET city = '\" + msg.message + \"' WHERE user_telegram_id = \" + msg.chat_id + \";\";\n        //for the next message\n        msg.text = \"Супер. Для кращого підбору FAQ 📊 виберіть свій вид зайнятості\";\n        \n        return [null, msg, null, null, null];\n    }\n}\n\n\n\nreturn [null, null, null, null, msg];",
        "outputs": 5,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1080,
        "y": 600,
        "wires": [
            [
                "6b11dc25.33b244"
            ],
            [
                "2e3fabf6.d47a14"
            ],
            [
                "5b53c12b.cc56"
            ],
            [
                "918b2c7e.02687"
            ],
            [
                "452a3d2.72b81c4"
            ]
        ],
        "outputLabels": [
            "Saving the username field",
            "Saving the city field",
            "Sending an error message",
            "DialogFlow Processing Message",
            "Checking whether the registration is completed"
        ]
    },
    {
        "id": "6b11dc25.33b244",
        "type": "mysql",
        "z": "cbf72f33.63dd6",
        "mydb": "529c4263.aeab0c",
        "name": "",
        "x": 1710,
        "y": 180,
        "wires": [
            [
                "bba92257.ecedb"
            ]
        ]
    },
    {
        "id": "feea9eea.8f9fd",
        "type": "debug",
        "z": "cbf72f33.63dd6",
        "name": "Getting username and city fields 'Chatting flow' response from db",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1020,
        "y": 680,
        "wires": []
    },
    {
        "id": "bba92257.ecedb",
        "type": "link out",
        "z": "cbf72f33.63dd6",
        "name": "Move on to setting the location field",
        "links": [
            "b0af6159.780a4",
            "1835ced7.6011d1"
        ],
        "x": 1915,
        "y": 180,
        "wires": []
    },
    {
        "id": "2e3fabf6.d47a14",
        "type": "mysql",
        "z": "cbf72f33.63dd6",
        "mydb": "529c4263.aeab0c",
        "name": "",
        "x": 1710,
        "y": 380,
        "wires": [
            [
                "76dc39c7.1f1908"
            ]
        ]
    },
    {
        "id": "76dc39c7.1f1908",
        "type": "link out",
        "z": "cbf72f33.63dd6",
        "name": "Move on to choosing occupation",
        "links": [
            "4b1be78d.e0a2d8",
            "62bdcfd6.d166e"
        ],
        "x": 1915,
        "y": 380,
        "wires": []
    },
    {
        "id": "5581481b.706b38",
        "type": "link in",
        "z": "cbf72f33.63dd6",
        "name": "Edit username or city or process message",
        "links": [
            "51ec0c6.d7d05f4"
        ],
        "x": 55,
        "y": 600,
        "wires": [
            [
                "65f1945a.2f170c"
            ]
        ]
    },
    {
        "id": "11cb9c66.1c2c64",
        "type": "comment",
        "z": "cbf72f33.63dd6",
        "name": "Processing other messages. Edit username or city",
        "info": "",
        "x": 230,
        "y": 560,
        "wires": []
    },
    {
        "id": "bd92a1fe.c5f6f",
        "type": "change",
        "z": "411ddac8.164cb4",
        "name": "Setting up bot url",
        "rules": [
            {
                "t": "set",
                "p": "url",
                "pt": "msg",
                "to": "\"https://api.telegram.org/bot\" & $env('TOKEN') & \"/sendMessage\"",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 330,
        "y": 80,
        "wires": [
            [
                "b8d99eac.ee468"
            ]
        ]
    },
    {
        "id": "b8d99eac.ee468",
        "type": "http request",
        "z": "411ddac8.164cb4",
        "name": "",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "basic",
        "x": 550,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "5d8decb2.3014e4",
        "type": "debug",
        "z": "cbf72f33.63dd6",
        "name": "Response from dialogflow",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 2170,
        "y": 860,
        "wires": []
    },
    {
        "id": "c82c545b.287d98",
        "type": "dialogflowv2",
        "z": "cbf72f33.63dd6",
        "dialogflow": "b513f9.a96b5c08",
        "language": "uk",
        "debug": false,
        "queryParamsOK": true,
        "x": 1940,
        "y": 780,
        "wires": [
            [
                "5d8decb2.3014e4",
                "8c22d5f5.4223e8"
            ]
        ]
    },
    {
        "id": "2c767f74.82a47",
        "type": "comment",
        "z": "cbf72f33.63dd6",
        "name": "DialogFlow Processing Message",
        "info": "",
        "x": 1990,
        "y": 740,
        "wires": []
    },
    {
        "id": "63a1490b.736ab8",
        "type": "function",
        "z": "cbf72f33.63dd6",
        "name": "Setting dialogflow response",
        "func": "msg.payload = {\n    chat_id: msg.chat_id\n}\n\ntry {\n    var jsonResponse = JSON.parse(msg._dialogflow.fulfillmentText.toString());\n    \n    msg.payload.text = jsonResponse.question;\n    \n    var answersArr = [];\n    jsonResponse.answers.forEach((item, i, arr) => {\n       answersArr.push({text: item.text, callback_data: \"^\" + item.callback_data});\n    });\n    \n    \n    msg.payload.reply_markup = {inline_keyboard: [answersArr]};\n    \n}catch (err) {\n    msg.payload.text = msg._dialogflow.fulfillmentText;\n}\n\n\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2720,
        "y": 780,
        "wires": [
            [
                "5a2ebc6a.567e54"
            ]
        ]
    },
    {
        "id": "985d37c2.3d2328",
        "type": "comment",
        "z": "cbf72f33.63dd6",
        "name": "Move on to setting the location field",
        "info": "",
        "x": 2040,
        "y": 140,
        "wires": []
    },
    {
        "id": "74b4671f.1c13a8",
        "type": "comment",
        "z": "cbf72f33.63dd6",
        "name": "Move on to choosing occupation",
        "info": "",
        "x": 2030,
        "y": 340,
        "wires": []
    },
    {
        "id": "452a3d2.72b81c4",
        "type": "link out",
        "z": "cbf72f33.63dd6",
        "name": "Is registration completed",
        "links": [
            "6ff45d49.c66084"
        ],
        "x": 1615,
        "y": 980,
        "wires": []
    },
    {
        "id": "1795e6cf.ce9ef9",
        "type": "comment",
        "z": "cbf72f33.63dd6",
        "name": "Checking whether the registration is completed",
        "info": "",
        "x": 1780,
        "y": 940,
        "wires": []
    },
    {
        "id": "8c22d5f5.4223e8",
        "type": "function",
        "z": "cbf72f33.63dd6",
        "name": "Saving dialogflow context",
        "func": "global.set(msg.chat_id.toString(), msg._dialogflow.outputContexts);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2330,
        "y": 780,
        "wires": [
            [
                "63a1490b.736ab8"
            ]
        ]
    },
    {
        "id": "1f4926d2.d54c49",
        "type": "comment",
        "z": "96f6108e.64a37",
        "name": "Move on to setting the location field again",
        "info": "",
        "x": 2620,
        "y": 380,
        "wires": []
    },
    {
        "id": "68d4e0a4.e71e1",
        "type": "comment",
        "z": "96f6108e.64a37",
        "name": "Move on to setting the occupation field again",
        "info": "",
        "x": 2890,
        "y": 440,
        "wires": []
    },
    {
        "id": "319d5b6f.be2d74",
        "type": "function",
        "z": "4001764a.8341f8",
        "name": "Removing inline keyboard",
        "func": "//remove inline keyboard\nmsg.payload = {\n    chat_id: msg.chat_id,\n    message_id: msg.message_id,\n    reply_markup: {\n        inline_keyboard: []\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 730,
        "y": 80,
        "wires": [
            [
                "ac12e929.bfded8"
            ]
        ]
    },
    {
        "id": "4a6d9a4d.b3d5b4",
        "type": "comment",
        "z": "cbf72f33.63dd6",
        "name": "Sending an error message",
        "info": "",
        "x": 1710,
        "y": 560,
        "wires": []
    },
    {
        "id": "a64a08f7.365978",
        "type": "comment",
        "z": "cbf72f33.63dd6",
        "name": "Saving the city field",
        "info": "",
        "x": 1690,
        "y": 340,
        "wires": []
    },
    {
        "id": "b908221a.202f7",
        "type": "comment",
        "z": "cbf72f33.63dd6",
        "name": "Saving the username field",
        "info": "",
        "x": 1710,
        "y": 140,
        "wires": []
    },
    {
        "id": "954a6c74.4f585",
        "type": "debug",
        "z": "96f6108e.64a37",
        "name": "Start command incoming data",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 430,
        "y": 420,
        "wires": []
    },
    {
        "id": "edb7746b.1cfc58",
        "type": "debug",
        "z": "276bc02d.e347",
        "name": "Getting info from InfoPage response from db",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1040,
        "y": 760,
        "wires": []
    },
    {
        "id": "8ce9f8ec.862708",
        "type": "mysql",
        "z": "68a30d94.469f94",
        "mydb": "529c4263.aeab0c",
        "name": "",
        "x": 2850,
        "y": 280,
        "wires": [
            [
                "bfff6d3f.b5c17",
                "59d394d6.305dac"
            ]
        ]
    },
    {
        "id": "e23ca452.8c77d8",
        "type": "comment",
        "z": "96f6108e.64a37",
        "name": "Checking whether the registration is completed",
        "info": "",
        "x": 1660,
        "y": 420,
        "wires": []
    },
    {
        "id": "5b53c12b.cc56",
        "type": "subflow:411ddac8.164cb4",
        "z": "cbf72f33.63dd6",
        "name": "",
        "env": [],
        "x": 1710,
        "y": 600,
        "wires": [
            []
        ]
    },
    {
        "id": "5a2ebc6a.567e54",
        "type": "subflow:411ddac8.164cb4",
        "z": "cbf72f33.63dd6",
        "name": "",
        "env": [],
        "x": 3110,
        "y": 780,
        "wires": [
            [
                "bd895bb.3ba4ea8"
            ]
        ]
    },
    {
        "id": "511ccf6f.c54f1",
        "type": "subflow:411ddac8.164cb4",
        "z": "276bc02d.e347",
        "name": "",
        "env": [],
        "x": 870,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "774ff602.a99368",
        "type": "subflow:411ddac8.164cb4",
        "z": "276bc02d.e347",
        "name": "",
        "env": [],
        "x": 1690,
        "y": 440,
        "wires": [
            []
        ]
    },
    {
        "id": "12dbdc86.9c06e3",
        "type": "subflow:411ddac8.164cb4",
        "z": "276bc02d.e347",
        "name": "",
        "env": [],
        "x": 1370,
        "y": 660,
        "wires": [
            []
        ]
    },
    {
        "id": "6a938578.b8740c",
        "type": "subflow:411ddac8.164cb4",
        "z": "68a30d94.469f94",
        "name": "",
        "env": [],
        "x": 720,
        "y": 300,
        "wires": [
            []
        ]
    },
    {
        "id": "bcaa2825.03ec98",
        "type": "subflow:411ddac8.164cb4",
        "z": "3b5b98a.1c38768",
        "name": "",
        "env": [],
        "x": 850,
        "y": 140,
        "wires": [
            [
                "f83bba65.663248"
            ]
        ]
    },
    {
        "id": "c538e448.9052c8",
        "type": "subflow:411ddac8.164cb4",
        "z": "4c6874fb.68b9dc",
        "name": "",
        "env": [],
        "x": 2130,
        "y": 160,
        "wires": [
            [
                "32bc9488.39455c"
            ]
        ]
    },
    {
        "id": "c965d10e.f8642",
        "type": "subflow:411ddac8.164cb4",
        "z": "96f6108e.64a37",
        "name": "",
        "env": [],
        "x": 1950,
        "y": 160,
        "wires": [
            [
                "af301238.403c5"
            ]
        ]
    },
    {
        "id": "cece57bc.ae7278",
        "type": "subflow:411ddac8.164cb4",
        "z": "96f6108e.64a37",
        "name": "",
        "env": [],
        "x": 4030,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "5cb0519f.6a6eb",
        "type": "subflow:4001764a.8341f8",
        "z": "68a30d94.469f94",
        "name": "",
        "env": [],
        "x": 2550,
        "y": 280,
        "wires": [
            [
                "8ce9f8ec.862708"
            ]
        ]
    },
    {
        "id": "731ab835.3cca28",
        "type": "subflow:4001764a.8341f8",
        "z": "96f6108e.64a37",
        "name": "",
        "env": [],
        "x": 3290,
        "y": 320,
        "wires": [
            [
                "20d295e5.2aa6ca"
            ]
        ]
    },
    {
        "id": "62f11abc.785b54",
        "type": "subflow:4001764a.8341f8",
        "z": "96f6108e.64a37",
        "name": "",
        "env": [],
        "x": 2570,
        "y": 480,
        "wires": [
            [
                "4984be9d.47765"
            ]
        ]
    },
    {
        "id": "fc1ff122.bdedf",
        "type": "comment",
        "z": "96f6108e.64a37",
        "name": "Move on to setting the username field",
        "info": "",
        "x": 910,
        "y": 400,
        "wires": []
    },
    {
        "id": "b7e1f0b9.548a",
        "type": "subflow:4001764a.8341f8",
        "z": "dbbd86af.74c0d8",
        "name": "",
        "env": [],
        "x": 1710,
        "y": 140,
        "wires": [
            [
                "96e4744d.d20358"
            ]
        ]
    },
    {
        "id": "d404fa4c.e63ca8",
        "type": "subflow:4001764a.8341f8",
        "z": "dbbd86af.74c0d8",
        "name": "",
        "env": [],
        "x": 1710,
        "y": 180,
        "wires": [
            [
                "b48e521d.7a459"
            ]
        ]
    },
    {
        "id": "bc2b504d.e7b25",
        "type": "change",
        "z": "dbbd86af.74c0d8",
        "name": "Saving message_id",
        "rules": [
            {
                "t": "set",
                "p": "message_id",
                "pt": "msg",
                "to": "payload.callback_query.message.message_id",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1470,
        "y": 180,
        "wires": [
            [
                "d404fa4c.e63ca8"
            ]
        ]
    },
    {
        "id": "a46d83e7.59837",
        "type": "change",
        "z": "4001764a.8341f8",
        "name": "Saving msg.payload",
        "rules": [
            {
                "t": "set",
                "p": "payload_copy",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 360,
        "y": 80,
        "wires": [
            [
                "319d5b6f.be2d74"
            ]
        ]
    },
    {
        "id": "cfe21d91.ca59b",
        "type": "change",
        "z": "4001764a.8341f8",
        "name": "Setting saved payload to msg.payload",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "payload_copy",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1730,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "b39d786c.8e4128",
        "type": "change",
        "z": "68a30d94.469f94",
        "name": "Saving message_id",
        "rules": [
            {
                "t": "set",
                "p": "message_id",
                "pt": "msg",
                "to": "payload.callback_query.message.message_id",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2290,
        "y": 280,
        "wires": [
            [
                "5cb0519f.6a6eb"
            ]
        ]
    },
    {
        "id": "ac12e929.bfded8",
        "type": "change",
        "z": "4001764a.8341f8",
        "name": "Setting up editMessageReplyMarkup url",
        "rules": [
            {
                "t": "set",
                "p": "url",
                "pt": "msg",
                "to": "\"https://api.telegram.org/bot\" & $env('TOKEN') & \"/editMessageReplyMarkup\"",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1060,
        "y": 80,
        "wires": [
            [
                "a41f75cf.a711d8"
            ]
        ]
    },
    {
        "id": "a41f75cf.a711d8",
        "type": "http request",
        "z": "4001764a.8341f8",
        "name": "",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "basic",
        "x": 1350,
        "y": 80,
        "wires": [
            [
                "cfe21d91.ca59b"
            ]
        ]
    },
    {
        "id": "9ac7a5f6.6b0578",
        "type": "function",
        "z": "96f6108e.64a37",
        "name": "Changing username field to null",
        "func": "msg.topic = \"UPDATE Users SET username = NULL WHERE user_telegram_id = \" + msg.chat_id + \";\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 2590,
        "y": 320,
        "wires": [
            [
                "30367045.2e04d"
            ]
        ]
    },
    {
        "id": "30367045.2e04d",
        "type": "mysql",
        "z": "96f6108e.64a37",
        "mydb": "529c4263.aeab0c",
        "name": "",
        "x": 2910,
        "y": 320,
        "wires": [
            [
                "731ab835.3cca28"
            ]
        ]
    },
    {
        "id": "b9737d21.50434",
        "type": "comment",
        "z": "96f6108e.64a37",
        "name": "Move on to setting the username field again",
        "info": "",
        "x": 2630,
        "y": 280,
        "wires": []
    },
    {
        "id": "918b2c7e.02687",
        "type": "subflow:4001764a.8341f8",
        "z": "cbf72f33.63dd6",
        "name": "",
        "env": [],
        "x": 1710,
        "y": 780,
        "wires": [
            [
                "c82c545b.287d98"
            ]
        ]
    },
    {
        "id": "883596f3.f874b8",
        "type": "subflow:4001764a.8341f8",
        "z": "dbbd86af.74c0d8",
        "name": "",
        "env": [],
        "x": 1710,
        "y": 800,
        "wires": [
            [
                "feec21d1.19a71"
            ]
        ]
    },
    {
        "id": "1c95075d.3fbc99",
        "type": "change",
        "z": "dbbd86af.74c0d8",
        "name": "Saving message_id",
        "rules": [
            {
                "t": "set",
                "p": "message_id",
                "pt": "msg",
                "to": "payload.callback_query.message.message_id",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1470,
        "y": 800,
        "wires": [
            [
                "883596f3.f874b8"
            ]
        ]
    },
    {
        "id": "4e826109.a4c38",
        "type": "subflow:4001764a.8341f8",
        "z": "dbbd86af.74c0d8",
        "name": "",
        "env": [],
        "x": 1710,
        "y": 700,
        "wires": [
            [
                "19842b4d.d40f45"
            ]
        ]
    },
    {
        "id": "fd346d51.349be",
        "type": "change",
        "z": "dbbd86af.74c0d8",
        "name": "Saving message_id",
        "rules": [
            {
                "t": "set",
                "p": "message_id",
                "pt": "msg",
                "to": "payload.callback_query.message.message_id",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1470,
        "y": 700,
        "wires": [
            [
                "4e826109.a4c38"
            ]
        ]
    },
    {
        "id": "63f8db61.634e64",
        "type": "subflow:4001764a.8341f8",
        "z": "dbbd86af.74c0d8",
        "name": "",
        "env": [],
        "x": 1710,
        "y": 600,
        "wires": [
            [
                "fee03af4.838098"
            ]
        ]
    },
    {
        "id": "1771062a.6b9e4a",
        "type": "change",
        "z": "dbbd86af.74c0d8",
        "name": "Saving message_id",
        "rules": [
            {
                "t": "set",
                "p": "message_id",
                "pt": "msg",
                "to": "payload.callback_query.message.message_id",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1470,
        "y": 600,
        "wires": [
            [
                "63f8db61.634e64"
            ]
        ]
    },
    {
        "id": "f9f65b6d.4cfe88",
        "type": "mysql",
        "z": "276bc02d.e347",
        "mydb": "529c4263.aeab0c",
        "name": "",
        "x": 730,
        "y": 440,
        "wires": [
            [
                "fd706c59.243ee"
            ]
        ]
    },
    {
        "id": "ed557bc6.5bffa8",
        "type": "function",
        "z": "276bc02d.e347",
        "name": "Getting info from InfoPages",
        "func": "msg.topic = \"SELECT * FROM questions ORDER BY calls DESC LIMIT 5;\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 440,
        "y": 440,
        "wires": [
            [
                "f9f65b6d.4cfe88"
            ]
        ]
    },
    {
        "id": "bd895bb.3ba4ea8",
        "type": "function",
        "z": "cbf72f33.63dd6",
        "name": "Getting info from Questions",
        "func": "msg.topic = \"SELECT * FROM questions WHERE intent = '\" + msg._dialogflow.intent.displayName.split(\" \").join(\"\") + \"';\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 3540,
        "y": 780,
        "wires": [
            [
                "348f6b3c.e36434"
            ]
        ]
    },
    {
        "id": "348f6b3c.e36434",
        "type": "mysql",
        "z": "cbf72f33.63dd6",
        "mydb": "529c4263.aeab0c",
        "name": "",
        "x": 3870,
        "y": 780,
        "wires": [
            [
                "a8d398a0.9fa888"
            ]
        ]
    },
    {
        "id": "a8d398a0.9fa888",
        "type": "function",
        "z": "cbf72f33.63dd6",
        "name": "Updating calls field of question",
        "func": "if (msg.payload.length) {\n    msg.topic = \"UPDATE questions SET calls = \" + (msg.payload[0].calls + 1) + \" WHERE intent = '\" + msg._dialogflow.intent.displayName.split(\" \").join(\"\") + \"';\"\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 4210,
        "y": 780,
        "wires": [
            [
                "1ac5f422.4e36ac",
                "c5e98fde.d258e"
            ]
        ]
    },
    {
        "id": "1ac5f422.4e36ac",
        "type": "mysql",
        "z": "cbf72f33.63dd6",
        "mydb": "529c4263.aeab0c",
        "name": "",
        "x": 4550,
        "y": 780,
        "wires": [
            []
        ]
    },
    {
        "id": "c5e98fde.d258e",
        "type": "debug",
        "z": "cbf72f33.63dd6",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 4480,
        "y": 860,
        "wires": []
    }
]